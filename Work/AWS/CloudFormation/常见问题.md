

## 问题合集



[toc]



### ChangeSet limit exceeded for stack

#### 问题描述
使用cloudformation 部署，通常会使用`--no-fail-on-empty-changeset`参数，这样可确保在模板未更改的情况下`deploy`命令不会引发错误.
但是`aws cloudformation deploy`命令本身不会清除那些失败的`changeset`。这导致`changeset`堆积起来,直到达到上限1000个

这个问题通常出现在测试环境，因为测试环境有频繁的部署，而stage和prod则不常见。
```shell
$ aws cloudformation deploy --template-file output.yml --stack-name example --no-fail-on-empty-changeset
```

#### 解决方式
在部署脚本中添加`cleanup`函数，删除失败的`changeset`.

这个`cleanup`函数能批量删除以特定`prefix`开头的stack的`changeset`
```shell
# cleanup (region, prefix)
cleanup () {
  stacks=$(aws cloudformation list-stacks --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE --query "StackSummaries[?starts_with(StackName, \`$2\`) == \`true\`].StackName" --output text --region $1)
  for stack in $stacks
  do
    echo "${stack}: cleaning up change sets"
    changesets=$(aws cloudformation list-change-sets --stack-name $stack --query 'Summaries[?Status==`FAILED`].ChangeSetId' --output text --region $1)
    for changeset in $changesets
    do
      echo "${stack}: deleting change set ${changeset}"
      aws cloudformation delete-change-set --change-set-name ${changeset} --region $1
    done
  done
}
```

这是删除单个stack的`cleanup`函数
```shell
# cleanup (Profile, Stack-name, [Region])
# It can clear the failed changeset in the stack, but need to change env/environment.yml, 
# add delete ChangeSet Action "DeleteChangeSet"
# Solve: An error occurred (LimitExceededException) when calling the CreateChangeSet operation: 
#       ChangeSet limit exceeded for stack ...
cleanup () {
    local profile=$1
    local stackname=$2
    local region=$3
    if [[ -z $region ]];then
      region=us-east-1
    fi
    echo "Cleaning up failed change sets"
    changesets=$(aws cloudformation list-change-sets \
        --profile $profile \
        --region $region \
        --stack-name $stackname --query 'Summaries[?Status==`FAILED`].ChangeSetId' --output text)
    echo changesets
    for changeset in $changesets; do
      echo "${stackname}: deleting change set ${changeset}"
      aws cloudformation delete-change-set \
        --profile $profile \
        --region $region \
        --stack-name $stackname \
        --change-set-name ${changeset}
    done
}
```


#### 参考链接：
https://cloudonaut.io/aws-cli-cloudformation-deploy-limit-exceeded/
